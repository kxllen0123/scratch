# 实施计划: Mock Agent API

## 概述

本实施计划将现有的 FastAPI 代码审查 API 转换为符合规范的实现，包括完整的测试覆盖、数据验证增强和项目结构优化。实施将采用增量方式，每个步骤都建立在前一步的基础上。

## 任务

- [x] 1. 设置项目依赖和测试框架
  - 创建 `apps/api/requirements.txt` 文件，包含 FastAPI、Uvicorn、Pydantic、pytest、pytest-cov、Hypothesis
  - 使用 `uv pip install` 安装所有依赖
  - 创建 `apps/api/tests/` 目录结构
  - 创建 `apps/api/pytest.ini` 配置文件
  - _需求: 7.1, 7.2_

- [x] 2. 增强数据模型验证
  - [x] 2.1 更新 CodeReviewRequest 模型添加验证约束
    - 添加 `code` 字段的最大长度验证（100,000 字符）
    - 添加 `code` 字段的非空验证
    - 添加 `language` 字段的默认值 "python"
    - _需求: 3.2, 3.3, 3.5_
  
  - [x] 2.2 更新 CodeSmell 模型添加验证约束
    - 添加 `type` 字段最小长度验证（≥ 3 字符）
    - 添加 `severity` 字段枚举验证（"low", "medium", "high"）
    - 添加 `line` 字段正整数验证（> 0）
    - 添加 `message` 字段最小长度验证（≥ 5 字符）
    - 添加 `suggestion` 字段最小长度验证（≥ 10 字符）
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_
  
  - [x] 2.3 更新 CodeReviewResponse 模型添加验证约束
    - 添加 `smells` 列表最小长度验证（≥ 1）
    - 添加 `summary` 字段最小长度验证（≥ 10 字符）
    - _需求: 4.3, 4.4_

- [x] 3. 编写单元测试 - API 配置和端点
  - [x] 3.1 编写测试验证 FastAPI 应用配置
    - **属性 1: API 配置正确性**
    - **验证需求: 1.1, 1.2**
  
  - [x] 3.2 编写测试验证根端点 GET /
    - 测试返回状态码 200
    - 测试返回消息 "Code-Sentinel API is running"
    - _需求: 2.1, 2.2_
  
  - [x] 3.3 编写测试验证健康检查端点 GET /health
    - 测试返回状态码 200
    - 测试返回状态 "healthy"
    - _需求: 2.3, 2.4_

- [x] 4. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [x] 5. 编写属性测试 - 输入验证
  - [x] 5.1 编写属性测试验证无效请求返回 422
    - **属性 3: 输入验证拒绝无效请求**
    - **验证需求: 3.2, 3.4, 7.3**
    - 使用 Hypothesis 生成各种无效输入（缺少字段、错误类型、超长代码）
    - 验证所有无效输入都返回 HTTP 422
  
  - [x] 5.2 编写单元测试验证空字符串边缘情况
    - 测试 code 为空字符串时返回 422
    - _需求: 3.5_
  
  - [x] 5.3 编写单元测试验证默认语言值
    - **属性 4: 默认语言值应用**
    - **验证需求: 3.3**
    - 测试不包含 language 字段时默认为 "python"

- [x] 6. 编写属性测试 - 成功响应结构
  - [x] 6.1 编写属性测试验证有效请求返回成功响应
    - **属性 5: 有效请求返回成功响应**
    - **验证需求: 4.1, 4.2**
    - 使用 Hypothesis 生成各种有效的 CodeReviewRequest
    - 验证返回 HTTP 200 和 status="success"
  
  - [x] 6.2 编写属性测试验证响应结构完整性
    - **属性 6: 响应结构完整性**
    - **验证需求: 4.3, 4.4, 4.5**
    - 验证 smells 列表恰好包含 3 个元素
    - 验证 summary 字段长度 ≥ 10 字符

- [x] 7. 编写属性测试 - Code Smell 结构和内容
  - [x] 7.1 编写属性测试验证 Code Smell 结构有效性
    - **属性 7: Code Smell 结构有效性**
    - **验证需求: 5.1, 5.2, 5.3, 5.4, 5.5**
    - 验证每个 Code_Smell 对象的所有字段符合约束
  
  - [x] 7.2 编写属性测试验证模拟数据一致性
    - **属性 8: 模拟数据一致性**
    - **验证需求: 6.1, 6.2, 6.3**
    - 验证返回的三个 smells 始终是预定义的值
  
  - [x] 7.3 编写属性测试验证 Summary 字段准确性
    - **属性 9: Summary 字段准确性**
    - **验证需求: 6.4, 6.5, 6.6**
    - 验证 summary 包含精确的字符数、语言和 smell 数量

- [x] 8. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [x] 9. 创建共享类型定义
  - [x] 9.1 在 `packages/types/` 创建 TypeScript 类型定义文件
    - 创建 `packages/types/api.ts` 文件
    - 定义 CodeReviewRequest、CodeSmell、CodeReviewResponse 接口
    - 确保与 Python Pydantic 模型保持一致
    - _需求: 所有数据模型_
  
  - [x] 9.2 编写类型定义的文档注释
    - 为每个接口添加 JSDoc 注释
    - 说明字段约束和验证规则

- [x] 10. 添加结构化日志记录
  - [x] 10.1 配置 Python 结构化日志
    - 在 `apps/api/main.py` 中配置日志记录
    - 使用 JSON 格式输出日志
    - 记录请求/响应信息
    - _需求: 可观测性要求_
  
  - [x] 10.2 编写日志记录测试
    - 验证关键操作都有日志输出
    - 验证日志格式正确

- [x] 11. 创建环境配置支持
  - [x] 11.1 创建配置管理模块
    - 创建 `apps/api/config.py` 文件
    - 支持 Dev、Stage、Prd 三个环境
    - 使用环境变量配置 CORS、日志级别等
    - _需求: 环境隔离要求_
  
  - [x] 11.2 更新 main.py 使用配置模块
    - 从配置模块读取 CORS 设置
    - 根据环境调整日志级别
    - _需求: 1.2_

- [x] 12. 创建 API 文档和 README
  - [x] 12.1 更新 `apps/api/README.md`
    - 添加 API 端点文档
    - 添加请求/响应示例
    - 添加开发和测试说明
    - 添加使用 uv 的命令示例
  
  - [x] 12.2 配置 FastAPI 自动文档
    - 为所有端点添加详细的 docstring
    - 配置 OpenAPI 文档的描述和示例

- [x] 13. 最终检查点 - 完整测试和验证
  - 运行完整测试套件
  - 验证测试覆盖率
  - 确保所有需求都已实现
  - 如有问题请询问用户

## 注意事项

- 每个任务都引用了具体的需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
- 使用 `uv` 作为包管理器（项目约束要求）
- 共享类型定义放在 `packages/types/`（项目约束要求）
